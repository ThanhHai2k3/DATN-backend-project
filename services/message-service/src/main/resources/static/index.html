    <!DOCTYPE html>
    <html>
    <head>
        <title>WebSocket Chat Test</title>
        <style>
            /* CSS kh√¥ng thay ƒë·ªïi, gi·ªØ nguy√™n nh∆∞ c≈© */
            body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 20px; }
            #messageForm { margin-top: 20px; display: flex; }
            #messageInput { flex-grow: 1; padding: 8px; }
            #messages { display: flex; flex-direction: column-reverse; height: 500px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; }
            .message-wrapper { position: relative; display: flex; flex-direction: column; }
            .message-container { margin: 5px 0; padding: 8px; border-radius: 8px; background-color: #f1f1f1; max-width: 80%; word-wrap: break-word; }
            .message-container.sent { background-color: #dcf8c6; align-self: flex-end; }
            .reactions { margin-top: 5px; }
            .reaction-item { cursor: pointer; display: inline-block; padding: 2px 5px; border-radius: 10px; background: #eee; margin-right: 5px; font-size: 12px; }
            .add-reaction-btn { visibility: hidden; opacity: 0; transition: opacity 0.2s; cursor: pointer; position: absolute; top: -10px; right: 20px; background: white; border-radius: 50%; padding: 2px 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); z-index: 10; }
            .message-wrapper:hover .add-reaction-btn { visibility: visible; opacity: 1; }
            .reaction-picker { display: none; position: absolute; top: -30px; right: 40px; background: white; border-radius: 15px; padding: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 11; }
            .reaction-picker span { cursor: pointer; margin: 0 4px; font-size: 18px; }
        </style>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    </head>
    <body>
    <h1>Real-time Chat (Conversation #1)</h1>
    <div id="messages"></div>
    <form id="messageForm" name="messageForm">
        <input type="text" id="messageInput" placeholder="Type a message..." autocomplete="off"/>
        <button type="submit">Send as Duke (ID=1)</button>
    </form>

    <script type="text/javascript">
        // --- C·∫§U H√åNH ---
        const CONVERSATION_ID = 1;
        const CURRENT_USER_ID = 1;
        const messagesArea = document.getElementById('messages');
        const emojiToEnumMap = {'üëç': 'LIKE', '‚ù§Ô∏è': 'LOVE', 'üòÇ': 'HAHA', 'üò¢': 'SAD'};

        // --- H√ÄM T·∫†O GIAO DI·ªÜN ---
        function displayMessage(message, prepend = true) {
    const messageWrapper = document.createElement('div');
    messageWrapper.className = 'message-wrapper';

    const messageContainer = document.createElement('div');
    messageContainer.id = `message-${message.id}`;
    messageContainer.className = 'message-container';

    const contentElement = document.createElement('p');
    contentElement.innerHTML = `<strong>${message.sender.fullName}:</strong> ${message.content || '<em>Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c thu h·ªìi</em>'}`;
    messageContainer.appendChild(contentElement);

    const reactionsContainer = document.createElement('div');
    reactionsContainer.className = 'reactions';
    messageContainer.appendChild(reactionsContainer);

    // ‚ùå B·ªé ƒêO·∫†N G·ªåI displayNewReaction() ·ªû ƒê√ÇY

    const reactionPicker = document.createElement('div');
    reactionPicker.className = 'reaction-picker';
    Object.keys(emojiToEnumMap).forEach(emoji => {
        const emojiSpan = document.createElement('span');
        emojiSpan.innerText = emoji;
        emojiSpan.onclick = () => {
            const enumValue = emojiToEnumMap[emoji];
            addReaction(message.id, enumValue);
            reactionPicker.style.display = 'none';
        };
        reactionPicker.appendChild(emojiSpan);
    });

    const addReactionBtn = document.createElement('span');
    addReactionBtn.className = 'add-reaction-btn';
    addReactionBtn.innerText = 'üôÇ';
    addReactionBtn.onclick = () => {
        reactionPicker.style.display = reactionPicker.style.display === 'block' ? 'none' : 'block';
    };

    if (message.sender.id === CURRENT_USER_ID) {
        messageContainer.classList.add('sent');
    }

    messageWrapper.appendChild(messageContainer);
    messageWrapper.appendChild(addReactionBtn);
    messageWrapper.appendChild(reactionPicker);

    if (prepend) {
        messagesArea.prepend(messageWrapper);
    } else {
        messagesArea.appendChild(messageWrapper);
    }

    // ‚úÖ G·ªåI SAU KHI APPEND (DOM ƒë√£ s·∫µn s√†ng)
    if (message.reactions && message.reactions.length > 0) {
        message.reactions.forEach(reaction => displayNewReaction(reaction));
    }
}


        // ... (c√°c h√†m displayNewReaction, removeReactionFromUI, v√† c√°c h√†m g·ªçi API v·∫´n gi·ªØ nguy√™n) ...
        function displayNewReaction(reaction) {
            const messageContainer = document.getElementById(`message-${reaction.messageId}`);
            if (!messageContainer) return;
            const reactionElement = document.createElement('span');
            reactionElement.className = 'reaction-item';
            reactionElement.id = `reaction-${reaction.id}`;
            const emojiToShow = Object.keys(emojiToEnumMap).find(key => emojiToEnumMap[key] === reaction.reactionType) || reaction.reactionType;
            reactionElement.innerText = emojiToShow;
            if (reaction.userId === CURRENT_USER_ID) {
                 reactionElement.onclick = () => removeReaction(reaction.id);
            }
            messageContainer.querySelector('.reactions').appendChild(reactionElement);
        }
        function removeReactionFromUI(payload) {
            const reactionElement = document.getElementById(`reaction-${payload.reactionId}`);
            if (reactionElement) {
                reactionElement.remove();
            }
        }
        function addReaction(messageId, reactionEnum) {
            fetch('/api/v1/reactions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ messageId: messageId, userId: CURRENT_USER_ID, reactionType: reactionEnum })
            }).then(res => res.ok ? console.log('Reaction added') : console.error('Failed to add reaction'));
        }
        function removeReaction(reactionId) {
             fetch(`/api/v1/reactions/${reactionId}?userId=${CURRENT_USER_ID}`, {
                method: 'DELETE'
            }).then(res => res.ok ? console.log('Reaction removed') : console.error('Failed to remove reaction'));
        }
        document.getElementById('messageForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const content = document.getElementById('messageInput').value.trim();
            if (content) {
                fetch('/api/v1/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ conversationId: CONVERSATION_ID, senderId: CURRENT_USER_ID, content, messageType: 'TEXT' })
                }).then(() => document.getElementById('messageInput').value = '');
            }
        });

        // --- LOGIC WEBSOCKET ---
        const socket = new SockJS('/ws');
        const stompClient = Stomp.over(socket);

        const onConnected = function() {
            console.log("ƒê√£ k·∫øt n·ªëi th√†nh c√¥ng ƒë·∫øn WebSocket!");
            stompClient.subscribe('/topic/conversation/' + CONVERSATION_ID, onEventReceived);
            loadHistory(); // G·ªçi h√†m t·∫£i l·ªãch s·ª≠ chat
        };

        // H√†m t·∫£i l·ªãch s·ª≠ chat
        function loadHistory() {
             fetch(`/api/v1/messages/conversation/${CONVERSATION_ID}?page=0&size=50`)
                .then(res => res.json())
                .then(page => {
                    messagesArea.innerHTML = ''; // X√≥a tin nh·∫Øn c≈© tr∆∞·ªõc khi t·∫£i
                    page.content.reverse().forEach(message => displayMessage(message, false));
                });
        }

        const onEventReceived = function(payload) {
            // B∆Ø·ªöC S·ª¨A L·ªñI 1: ƒê·∫¢M B·∫¢O PAYLOAD L√Ä WEBSOCKETEVENT
            const event = JSON.parse(payload.body);
            console.log("Received event: ", event);

            switch (event.eventType) {
                case "NEW_MESSAGE":
                    displayMessage(event.payload, true); // S·ª≠a l·∫°i prepend th√†nh true
                    break;
                case "ADD_REACTION":
                    displayNewReaction(event.payload);
                    break;
                case "REMOVE_REACTION":
                    removeReactionFromUI(event.payload);
                    break;
            }
        };

        stompClient.connect({}, onConnected, () => console.error('L·ªói k·∫øt n·ªëi WebSocket.'));
    </script>
    </body>
    </html>